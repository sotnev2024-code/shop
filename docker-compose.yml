# Production для Timeweb: без version, без volumes (ограничение облака), без env_file
# Переменные backend — в панели облака: BOT_TOKEN, WEBAPP_URL, SECRET_KEY, ADMIN_IDS, OWNER_ID
# Локальная разработка: docker compose -f docker-compose.dev.yml up -d --build
# Внимание: без volumes данные PostgreSQL не сохраняются между перезапусками контейнера

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: shop_user
      POSTGRES_PASSWORD: shop_pass
      POSTGRES_DB: shop_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shop_user -d shop_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build: ./backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://shop_user:shop_pass@db:5432/shop_db
      REDIS_URL: redis://redis:6379/0
      BOT_TOKEN: ${BOT_TOKEN}
      WEBAPP_URL: ${WEBAPP_URL}
      ADMIN_CHAT_ID: ${ADMIN_CHAT_ID:-0}
      SECRET_KEY: ${SECRET_KEY:-change-me}
      ADMIN_IDS: ${ADMIN_IDS}
      OWNER_ID: ${OWNER_ID:-0}
      CHECKOUT_TYPE: ${CHECKOUT_TYPE:-basic}
      PRODUCT_SOURCE: ${PRODUCT_SOURCE:-database}
      DELIVERY_ENABLED: ${DELIVERY_ENABLED:-false}
      PICKUP_ENABLED: ${PICKUP_ENABLED:-true}
      PROMO_ENABLED: ${PROMO_ENABLED:-true}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - backend
