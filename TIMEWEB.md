# Деплой на Timeweb Cloud

У облака есть ограничения на `docker-compose`: нельзя использовать **именованные volumes** и устаревший **version**. Файл **docker-compose.timeweb.yml** подготовлен под эти требования.

## Что сделано в docker-compose.timeweb.yml

1. **Удалён блок `version`** — он больше не нужен и вызывает предупреждение.
2. **Убраны именованные volumes** — вместо `postgres_data` используется каталог на диске: `./data/postgres`. Данные БД сохраняются между перезапусками.
3. **Убран `env_file`** — файл `backend/.env` не попадает в репозиторий, поэтому переменные задаются в панели Timeweb.

## Что сделать в панели Timeweb

### 1. Какой compose-файл использовать

- Если в настройках деплоя можно указать имя файла — выберите **`docker-compose.timeweb.yml`**.
- Если панель всегда использует только **`docker-compose.yml`** — переименуйте файл на сервере или в репозитории:
  - либо положите содержимое `docker-compose.timeweb.yml` в основной `docker-compose.yml`,
  - либо сделайте копию: скопируйте `docker-compose.timeweb.yml` в `docker-compose.yml` и закоммитьте.

### 2. Переменные окружения для сервиса backend (обязательно)

Если не задать переменные, в логах будут предупреждения («BOT_TOKEN variable is not set» и т.д.) и бот/админка не заработают. В панели Timeweb откройте настройки приложения → переменные окружения и добавьте для сервиса **backend**:

| Переменная    | Обязательно | Пример / описание |
|---------------|-------------|-------------------|
| `BOT_TOKEN`   | Да          | Токен от @BotFather |
| `WEBAPP_URL`  | Да          | URL вашего приложения, например `https://ваш-домен.ru` |
| `SECRET_KEY`  | Да          | Любая длинная случайная строка |
| `ADMIN_IDS`   | Да          | Telegram ID админов через запятую, например `123456789` |
| `OWNER_ID`    | Рекомендуется | Telegram ID владельца |
| `ADMIN_CHAT_ID` | Нет       | ID чата для уведомлений (число) |
| Остальные     | Нет         | По желанию: `CHECKOUT_TYPE`, `PRODUCT_SOURCE`, `DELIVERY_ENABLED`, `PICKUP_ENABLED`, `PROMO_ENABLED`, интеграции и т.д. |

Значения по умолчанию для БД и Redis в compose уже прописаны (подключение к сервисам `db` и `redis`), их в панели задавать не нужно.

### 3. Если сборка падает

Нужен **точный текст ошибки** из логов деплоя (какой сервис: backend или app, и последние 20–30 строк).

Частые причины:
- **app** (фронт): не хватает памяти при `npm run build` — в образе добавлен `NODE_OPTIONS=--max-old-space-size=4096`; если ошибка другая (например `Cannot find module`) — пришлите вывод.
- **app**: `No such file or directory` при COPY — сборка должна идти из **корня репозитория** (где есть папки `frontend/`, `backend/`, `Dockerfile.prod`). В настройках деплоя не указывайте подкаталог как корень.
- **backend**: проверьте, что в репозитории есть `backend/requirements.txt` и `backend/app/`.

Скопируйте из логов фрагмент с ошибкой и по нему можно будет указать точную причину.

### 4. «Недействительный ответ» при https:// — что сделать

Сейчас приложение отдаёт только **HTTP** (порт 80). При открытии **https://** браузер ждёт TLS, а сервер так не настроен → ошибка «не может обеспечить безопасное соединение» / «недействительный ответ».

**Шаг 1. Проверьте по HTTP (без S):**  
Откройте в браузере:
- **http://shop.plus-shop.ru:8080**  
или  
- **http://shop.plus-shop.ru**  

Если страница открывается — приложение работает, осталось включить HTTPS.

**Шаг 2. Включите HTTPS в панели Timeweb:**  
Нужен нормальный SSL-сертификат (например Let's Encrypt), который обычно настраивает сама платформа:

1. Зайдите в **Timeweb Cloud** → ваше приложение (Docker Compose).
2. Найдите раздел **«Домены»**, **«Домены и SSL»** или **«Настройки»** → привязка домена.
3. Выберите домен **shop.plus-shop.ru** (или добавьте его).
4. Включите **SSL** / **HTTPS** / **«Выпустить сертификат»** (Let's Encrypt).
5. Укажите, что трафик на этот домен идёт на порт **8080** (если спрашивают порт приложения).

После этого **https://shop.plus-shop.ru** должен открываться без ошибки.  
Для Telegram Mini App нужен именно доверенный HTTPS (Let's Encrypt из панели подойдёт).

Если в панели нет возможности включить SSL для этого приложения — напишите в поддержку Timeweb: «Как включить HTTPS (Let's Encrypt) для домена shop.plus-shop.ru у Docker Compose приложения?»

### 5. Порт и доступ к сайту

Приложение в контейнере слушает порт **80**, но на хосте оно опубликовано как **8080** (из‑за занятого порта 80). Поэтому по умолчанию домен **не открывается** без указания порта.

**Что сделать:**

1. **Проверьте, что приложение вообще отвечает** — откройте в браузере:
   - **https://shop.plus-shop.ru:8080**  
   или  
   - **http://shop.plus-shop.ru:8080**
   Если страница загружается — контейнеры работают, вопрос только в маршрутизации.

2. **Настройка домена без :8080 в панели Timeweb:**
   - Зайдите в приложение (Docker Compose) → **Настройки** / **Сеть** / **Домены**.
   - Найдите параметр вроде **«Порт приложения»**, **«Application port»** или **«Куда проксировать трафик»** и укажите **8080** (порт на хосте, куда смотрит ваш контейнер `app`).
   - Либо привяжите домен к сервису **app** и укажите порт **8080**, если панель это позволяет.
   Так трафик на `https://shop.plus-shop.ru` (порты 80/443) будет перенаправляться на ваш сервис на 8080.

3. **WEBAPP_URL** в переменных окружения backend задайте так:
   - если сайт открывается только по `:8080` — **https://shop.plus-shop.ru:8080**;
   - если после настройки порта в панели сайт открывается без порта — **https://shop.plus-shop.ru**.

4. **Если в панели нельзя указать порт 8080 для домена**, можно попробовать снова открыть порт 80: в `docker-compose.yml` заменить `"8080:80"` на `"80:80"` и перезапустить деплой. Иногда порт 80 освобождается после перезапуска. Если снова появится ошибка «port is already allocated», верните `"8080:80"` и используйте адрес с :8080.
- Если снова появится ошибка про `volumes` — значит, запрещены и bind mount’ы. Тогда напишите в поддержку Timeweb, что для PostgreSQL нужен каталог для данных (`./data/postgres`), и уточните, как в их окружении разрешено сохранять данные между перезапусками.
