# Деплой на Timeweb Cloud

У облака есть ограничения на `docker-compose`: нельзя использовать **именованные volumes** и устаревший **version**. Файл **docker-compose.timeweb.yml** подготовлен под эти требования.

## Что сделано в docker-compose.timeweb.yml

1. **Удалён блок `version`** — он больше не нужен и вызывает предупреждение.
2. **Убраны именованные volumes** — вместо `postgres_data` используется каталог на диске: `./data/postgres`. Данные БД сохраняются между перезапусками.
3. **Убран `env_file`** — файл `backend/.env` не попадает в репозиторий, поэтому переменные задаются в панели Timeweb.

## Что сделать в панели Timeweb

### 1. Какой compose-файл использовать

- Если в настройках деплоя можно указать имя файла — выберите **`docker-compose.timeweb.yml`**.
- Если панель всегда использует только **`docker-compose.yml`** — переименуйте файл на сервере или в репозитории:
  - либо положите содержимое `docker-compose.timeweb.yml` в основной `docker-compose.yml`,
  - либо сделайте копию: скопируйте `docker-compose.timeweb.yml` в `docker-compose.yml` и закоммитьте.

### 2. Переменные окружения для сервиса backend

В разделе настроек приложения / сервиса **backend** добавьте переменные окружения (через панель Timeweb, не файл):

| Переменная    | Обязательно | Пример / описание |
|---------------|-------------|-------------------|
| `BOT_TOKEN`   | Да          | Токен от @BotFather |
| `WEBAPP_URL`  | Да          | URL вашего приложения, например `https://ваш-домен.ru` |
| `SECRET_KEY`  | Да          | Любая длинная случайная строка |
| `ADMIN_IDS`   | Да          | Telegram ID админов через запятую, например `123456789` |
| `OWNER_ID`    | Рекомендуется | Telegram ID владельца |
| `ADMIN_CHAT_ID` | Нет       | ID чата для уведомлений (число) |
| Остальные     | Нет         | По желанию: `CHECKOUT_TYPE`, `PRODUCT_SOURCE`, `DELIVERY_ENABLED`, `PICKUP_ENABLED`, `PROMO_ENABLED`, интеграции и т.д. |

Значения по умолчанию для БД и Redis в compose уже прописаны (подключение к сервисам `db` и `redis`), их в панели задавать не нужно.

### 3. Если сборка падает

Нужен **точный текст ошибки** из логов деплоя (какой сервис: backend или app, и последние 20–30 строк).

Частые причины:
- **app** (фронт): не хватает памяти при `npm run build` — в образе добавлен `NODE_OPTIONS=--max-old-space-size=4096`; если ошибка другая (например `Cannot find module`) — пришлите вывод.
- **app**: `No such file or directory` при COPY — сборка должна идти из **корня репозитория** (где есть папки `frontend/`, `backend/`, `Dockerfile.prod`). В настройках деплоя не указывайте подкаталог как корень.
- **backend**: проверьте, что в репозитории есть `backend/requirements.txt` и `backend/app/`.

Скопируйте из логов фрагмент с ошибкой и по нему можно будет указать точную причину.

### 4. После деплоя

- Приложение должно открываться по порту **80** (или по выданному облаком домену).
- Если снова появится ошибка про `volumes` — значит, запрещены и bind mount’ы. Тогда напишите в поддержку Timeweb, что для PostgreSQL нужен каталог для данных (`./data/postgres`), и уточните, как в их окружении разрешено сохранять данные между перезапусками.
